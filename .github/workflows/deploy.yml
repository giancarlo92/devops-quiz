name: CI/CD Pipeline - DevOps Quiz

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Desplegar a producciÃ³n'
        required: true
        default: 'true'

permissions:
  contents: read

concurrency:
  group: devops-quiz-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login a Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Construir y pushear imagen Docker - DevOps Quiz
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/devops-quiz:latest
            ${{ secrets.DOCKER_USERNAME }}/devops-quiz:${{ github.sha }}
          no-cache: true

      - name: Desplegar via Docker Stack (Swarm)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          timeout: 60s
          command_timeout: 10m
          script: |
            # ConfiguraciÃ³n
            DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            DOCKER_TOKEN="${{ secrets.DOCKER_TOKEN }}"
            STACK_NAME="devops-quiz"
            DOMAIN="app-devops-quiz.autocode.online"

            # Login a Docker
            echo "${DOCKER_TOKEN}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

            # Crear archivo docker-stack.yml para DevOps Quiz
            cat > /tmp/devops-quiz-stack.yml << 'EOF'
            version: "3.8"

            services:
              devops-quiz:
                image: ${{ secrets.DOCKER_USERNAME }}/devops-quiz:latest
                networks:
                  - autocodenet
                deploy:
                  mode: replicated
                  replicas: 1
                  placement:
                    constraints:
                      - node.role == manager
                  labels:
                    - traefik.enable=true
                    - traefik.http.routers.devops-quiz.rule=Host(`app-devops-quiz.autocode.online`)
                    - traefik.http.routers.devops-quiz.entrypoints=websecure
                    - traefik.http.routers.devops-quiz.tls.certresolver=letsencryptresolver
                    - traefik.http.services.devops-quiz.loadbalancer.server.port=80
                    - traefik.http.services.devops-quiz.loadbalancer.passHostHeader=true
                  restart_policy:
                    condition: on-failure
                    delay: 5s
                    max_attempts: 3
                  update_config:
                    parallelism: 1
                    delay: 10s
                    failure_action: rollback
                    order: start-first

            networks:
              autocodenet:
                external: true
                name: autocodenet
            EOF
            
            # Verificar si existe y eliminar stack existente
            if docker stack ls --format "{{.Name}}" | grep -q "^${STACK_NAME}$"; then
              echo "Eliminando stack existente: ${STACK_NAME}"
              docker stack rm ${STACK_NAME}
              sleep 20
            fi

            # Pull de la imagen mÃ¡s reciente
            echo "ðŸ“¥ Descargando imagen mÃ¡s reciente..."
            docker pull ${DOCKER_USERNAME}/devops-quiz:latest

            # Desplegar stack
            echo "ðŸš€ Desplegando stack: ${STACK_NAME}"
            docker stack deploy -c /tmp/devops-quiz-stack.yml ${STACK_NAME} --with-registry-auth
            echo "âœ… Stack desplegado via Docker CLI"

            # Guardar copia del archivo para referencia
            mkdir -p ~/devops_quiz_stack
            cp /tmp/devops-quiz-stack.yml ~/devops_quiz_stack/docker-stack-$(date +%Y%m%d_%H%M%S).yml
            echo "ðŸ“„ Archivo de stack guardado en ~/devops_quiz_stack/"
            echo "âš ï¸ Nota: Para actualizar la visualizaciÃ³n en Portainer, deberÃ¡ importar manualmente el stack."